import streamlit as st
import pandas as pd
import numpy as np

@st.cache_data
def load_data():
    """Load and validate dataset"""
    try:
        df = pd.read_csv('https://raw.githubusercontent.com/RichardFreedman/Encoding_Music/main/06_SoundMap/bicomap.csv')
        
        # Clean data
        df = df.dropna(subset=['latitude', 'longitude'])
        
        # Validate coordinate ranges
        df = df[
            (df['latitude'].between(-90, 90)) & 
            (df['longitude'].between(-180, 180))
        ]
        
        return df
        
    except Exception as e:
        st.error(f"Error loading data: {str(e)}")
        st.stop()

# App Setup
st.title('Bi-Co Sound Survey Computational Essay')
st.markdown('By Logan Griffin, Luke Sheppard, Reed Solomon, and Jade Yu')
st.markdown('Sounds of Silence: A Sound Survey of the Bi-Co During Finals Week')

# Load data
df = load_data()

# Sidebar Controls
with st.sidebar:
    st.header("Filters")
    
    volume_min = float(df['volume'].min())
    volume_max = float(df['volume'].max())
    
    volume_threshold = st.slider(
        "Maximum Volume Threshold",
        min_value=volume_min,
        max_value=volume_max,
        value=volume_max,
        step=0.1
    )
    
    show_data = st.checkbox('Show Filtered Data', value=False)

# Filter data
filtered_df = df[df['volume'] <= volume_threshold]

# Display filtered data if requested
if show_data:
    st.subheader("Filtered Data")
    st.write(filtered_df)

# Display map using Streamlit's native map
st.subheader("Sound Survey Map")

if len(filtered_df) == 0:
    st.warning("No data points match the current filter criteria.")
else:
    # Prepare data for Streamlit map
    map_data = filtered_df[['latitude', 'longitude']].copy()
    
    # Add size based on volume (optional)
    map_data['size'] = filtered_df['volume'] * 10  # Scale for visibility
    
    # Display the map
    st.map(map_data, size='size', zoom=12)
    
    # Show location details below map
    st.subheader("Location Details")
    for idx, row in filtered_df.iterrows():
        with st.expander(f"{row['location']} (Volume: {row['volume']})"):
            st.write(f"**Coordinates:** {row['latitude']}, {row['longitude']}")
            st.write(f"**Volume:** {row['volume']}")
            if 'distractability' in row:
                st.write(f"**Distractability:** {row['distractability']}")
            if 'rowdiness' in row:
                st.write(f"**Rowdiness:** {row['rowdiness']}")

# Debug Information
with st.expander("Debug Information"):
    st.write(f"**Total data points:** {len(df)}")
    st.write(f"**Filtered data points:** {len(filtered_df)}")
    st.write(f"**Volume threshold:** {volume_threshold}")
    
    if len(filtered_df) > 0:
        st.write("**Sample coordinates:**")
        st.write(filtered_df[['latitude', 'longitude', 'location', 'volume']].head())